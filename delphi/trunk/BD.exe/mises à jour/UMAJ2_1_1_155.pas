unit UMAJ2_1_1_155;

interface

implementation

uses UIB, Updates;

procedure MAJ2_2_1_155(Query: TUIBScript);
begin
  with Query do
  begin
    Script.Clear;

    Script.Add('alter procedure achatalbums_by_editeur (');
    Script.Add('    id_editeur type of column editeurs.id_editeur,');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    id_album type of column albums.id_album,');
    Script.Add('    titrealbum type of column albums.titrealbum,');
    Script.Add('    tome type of column albums.tome,');
    Script.Add('    tomedebut type of column albums.tomedebut,');
    Script.Add('    tomefin type of column albums.tomefin,');
    Script.Add('    horsserie type of column albums.horsserie,');
    Script.Add('    integrale type of column albums.integrale,');
    Script.Add('    moisparution type of column albums.moisparution,');
    Script.Add('    anneeparution type of column albums.anneeparution,');
    Script.Add('    notation type of column albums.notation,');
    Script.Add('    id_serie type of column series.id_serie,');
    Script.Add('    titreserie type of column series.titreserie,');
    Script.Add('    achat type of column albums.achat,');
    Script.Add('    complet type of column albums.complet)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(133);');
    Script.Add('begin');
    Script.Add('  if (:id_editeur = cast('''' as char(38))) then');
    Script.Add('    swhere = ''s.id_editeur is null '';');
    Script.Add('  else');
    Script.Add('    swhere = ''s.id_editeur = '''''' || :id_editeur || '''''' '';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = swhere || ''and '' || filtre || '' '';');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      a.id_album, a.titrealbum, a.tome, a.tomedebut, a.tomefin, a.horsserie,');
    Script.Add('      a.integrale, a.moisparution, a.anneeparution, a.notation, a.id_serie,');
    Script.Add('      s.titreserie, a.achat, a.complet');
    Script.Add('    from');
    Script.Add('      albums a');
    Script.Add('      left join series s on');
    Script.Add('        a.id_serie = s.id_serie');
    Script.Add('    where');
    Script.Add('      '' || :swhere || ''');
    Script.Add('    order by');
    Script.Add('      coalesce(a.titrealbum, s.titreserie), s.titreserie,');
    Script.Add('      a.horsserie nulls first, a.integrale nulls first, a.tome nulls first,');
    Script.Add('      a.tomedebut nulls first, a.tomefin nulls first,');
    Script.Add('      a.anneeparution nulls first, a.moisparution nulls first''');
    Script.Add('    into');
    Script.Add('      :id_album, :titrealbum, :tome, :tomedebut, :tomefin, :horsserie,');
    Script.Add('      :integrale, :moisparution, :anneeparution, :notation, :id_serie,');
    Script.Add('      :titreserie, :achat, :complet');
    Script.Add('  do');
    Script.Add('  begin');
    Script.Add('    suspend;');
    Script.Add('  end');
    Script.Add('end;');

    Script.Add('alter procedure albums_by_annee (');
    Script.Add('    annee type of column albums.anneeparution,');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    id_album type of column albums.id_album,');
    Script.Add('    titrealbum type of column albums.titrealbum,');
    Script.Add('    tome type of column albums.tome,');
    Script.Add('    tomedebut type of column albums.tomedebut,');
    Script.Add('    tomefin type of column albums.tomefin,');
    Script.Add('    horsserie type of column albums.horsserie,');
    Script.Add('    integrale type of column albums.integrale,');
    Script.Add('    moisparution type of column albums.moisparution,');
    Script.Add('    anneeparution type of column albums.anneeparution,');
    Script.Add('    notation type of column albums.notation,');
    Script.Add('    id_serie type of column series.id_serie,');
    Script.Add('    titreserie type of column series.titreserie,');
    Script.Add('    achat type of column albums.achat,');
    Script.Add('    complet type of column albums.complet)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(200);');
    Script.Add('begin');
    Script.Add('  if (:annee = -1) then swhere = ''anneeparution is null '';');
    Script.Add('                   else swhere = ''anneeparution = '' || :annee || '' '';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = swhere || ''and '' || filtre || '' '';');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      id_album, titrealbum, tome, tomedebut, tomefin, horsserie,');
    Script.Add('      integrale, moisparution, anneeparution, notation, id_serie,');
    Script.Add('      titreserie, achat, complet');
    Script.Add('    from');
    Script.Add('      vw_liste_albums');
    Script.Add('    where');
    Script.Add('      '' || :swhere || ''');
    Script.Add('    order by');
    Script.Add('      coalesce(titrealbum, titreserie), titreserie, horsserie nulls first,');
    Script.Add('      integrale nulls first, tome nulls first, tomedebut nulls first,');
    Script.Add('      tomefin nulls first, anneeparution nulls first, moisparution nulls first''');
    Script.Add('    into');
    Script.Add('      :id_album, :titrealbum, :tome, :tomedebut, :tomefin, :horsserie,');
    Script.Add('      :integrale, :moisparution, :anneeparution, :notation, :id_serie,');
    Script.Add('      :titreserie, :achat, :complet');
    Script.Add('  do');
    Script.Add('  begin');
    Script.Add('    suspend;');
    Script.Add('  end');
    Script.Add('end;');

    Script.Add('alter procedure albums_by_auteur (');
    Script.Add('    id_auteur type of column personnes.id_personne,');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    id_album type of column albums.id_album,');
    Script.Add('    titrealbum type of column albums.titrealbum,');
    Script.Add('    tome type of column albums.tome,');
    Script.Add('    tomedebut type of column albums.tomedebut,');
    Script.Add('    tomefin type of column albums.tomefin,');
    Script.Add('    horsserie type of column albums.horsserie,');
    Script.Add('    integrale type of column albums.integrale,');
    Script.Add('    moisparution type of column albums.moisparution,');
    Script.Add('    anneeparution type of column albums.anneeparution,');
    Script.Add('    notation type of column albums.notation,');
    Script.Add('    id_serie type of column series.id_serie,');
    Script.Add('    titreserie type of column series.titreserie,');
    Script.Add('    metier type of column auteurs.metier,');
    Script.Add('    achat type of column albums.achat,');
    Script.Add('    complet type of column albums.complet)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(200);');
    Script.Add('begin');
    Script.Add('  swhere = '''';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = ''and '' || filtre || '' '';');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      a.id_album, a.titrealbum, a.tome, a.tomedebut, a.tomefin, a.horsserie,');
    Script.Add('      a.integrale, a.moisparution, a.anneeparution, a.notation, a.id_serie,');
    Script.Add('      a.titreserie, au.metier, a.achat, a.complet');
    Script.Add('    from');
    Script.Add('      vw_liste_albums a');
    Script.Add('      inner join auteurs au on');
    Script.Add('        a.id_album = au.id_album');
    Script.Add('    where');
    Script.Add('      au.id_personne = '''''' || :id_auteur || '''''' '' || swhere || ''');
    Script.Add('    order by');
    Script.Add('      titreserie, horsserie nulls first, integrale nulls first,');
    Script.Add('      tome nulls first, anneeparution nulls first, moisparution nulls first,');
    Script.Add('      coalesce(titrealbum, titreserie), metier''');
    Script.Add('    into');
    Script.Add('      :id_album, :titrealbum, :tome, :tomedebut, :tomefin, :horsserie,');
    Script.Add('      :integrale, :moisparution, :anneeparution, :notation, :id_serie,');
    Script.Add('      :titreserie, :metier, :achat, :complet');
    Script.Add('  do');
    Script.Add('  begin');
    Script.Add('    suspend;');
    Script.Add('  end');
    Script.Add('end;');

    Script.Add('alter procedure albums_by_collection (');
    Script.Add('    id_collection type of column collections.id_collection,');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    id_album type of column albums.id_album,');
    Script.Add('    titrealbum type of column albums.titrealbum,');
    Script.Add('    tome type of column albums.tome,');
    Script.Add('    tomedebut type of column albums.tomedebut,');
    Script.Add('    tomefin type of column albums.tomefin,');
    Script.Add('    horsserie type of column albums.horsserie,');
    Script.Add('    integrale type of column albums.integrale,');
    Script.Add('    moisparution type of column albums.moisparution,');
    Script.Add('    anneeparution type of column albums.anneeparution,');
    Script.Add('    notation type of column albums.notation,');
    Script.Add('    id_serie type of column series.id_serie,');
    Script.Add('    titreserie type of column series.titreserie,');
    Script.Add('    achat type of column albums.achat,');
    Script.Add('    complet type of column albums.complet)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(200);');
    Script.Add('begin');
    Script.Add('  if (:id_collection = cast('''' as char(38))) then');
    Script.Add('    swhere = ''e.id_collection is null '';');
    Script.Add('  else');
    Script.Add('    swhere = ''e.id_collection = '''''' || :id_collection || '''''' '';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = swhere || ''and '' || filtre || '' '';');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      a.id_album, a.titrealbum, a.tome, a.tomedebut, a.tomefin, a.horsserie,');
    Script.Add('      a.integrale, a.moisparution, a.anneeparution, a.notation, a.id_serie,');
    Script.Add('      s.titreserie, a.achat, a.complet');
    Script.Add('    from');
    Script.Add('      albums a');
    Script.Add('      left join editions e on');
    Script.Add('        a.id_album = e.id_album');
    Script.Add('      left join series s on');
    Script.Add('        a.id_serie = s.id_serie');
    Script.Add('    where');
    Script.Add('      '' || :swhere || ''');
    Script.Add('    order by');
    Script.Add('      coalesce(a.titrealbum, s.titreserie), s.titreserie,');
    Script.Add('      a.horsserie nulls first, a.integrale nulls first, a.tome nulls first,');
    Script.Add('      a.tomedebut nulls first, a.tomefin nulls first,');
    Script.Add('      a.anneeparution nulls first, a.moisparution nulls first''');
    Script.Add('    into');
    Script.Add('      :id_album, :titrealbum, :tome, :tomedebut, :tomefin, :horsserie,');
    Script.Add('      :integrale, :moisparution, :anneeparution, :notation, :id_serie,');
    Script.Add('      :titreserie, :achat, :complet');
    Script.Add('  do');
    Script.Add('  begin');
    Script.Add('    suspend;');
    Script.Add('  end');
    Script.Add('end;');

    Script.Add('alter procedure albums_by_editeur (');
    Script.Add('    id_editeur type of column editeurs.id_editeur,');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    id_album type of column albums.id_album,');
    Script.Add('    titrealbum type of column albums.titrealbum,');
    Script.Add('    tome type of column albums.tome,');
    Script.Add('    tomedebut type of column albums.tomedebut,');
    Script.Add('    tomefin type of column albums.tomefin,');
    Script.Add('    horsserie type of column albums.horsserie,');
    Script.Add('    integrale type of column albums.integrale,');
    Script.Add('    moisparution type of column albums.moisparution,');
    Script.Add('    anneeparution type of column albums.anneeparution,');
    Script.Add('    notation type of column albums.notation,');
    Script.Add('    id_serie type of column series.id_serie,');
    Script.Add('    titreserie type of column series.titreserie,');
    Script.Add('    achat type of column albums.achat,');
    Script.Add('    complet type of column albums.complet)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(133);');
    Script.Add('begin');
    Script.Add('  if (:id_editeur = cast('''' as char(38))) then');
    Script.Add('    swhere = ''e.id_editeur is null '';');
    Script.Add('  else');
    Script.Add('    swhere = ''e.id_editeur = '''''' || :id_editeur || '''''' '';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = swhere || ''and '' || filtre || '' '';');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      a.id_album, a.titrealbum, a.tome, a.tomedebut, a.tomefin, a.horsserie,');
    Script.Add('      a.integrale, a.moisparution, a.anneeparution, a.notation, a.id_serie,');
    Script.Add('      s.titreserie, a.achat, a.complet');
    Script.Add('    from');
    Script.Add('      albums a');
    Script.Add('      left join editions e on');
    Script.Add('        a.id_album = e.id_album');
    Script.Add('      left join series s on');
    Script.Add('        a.id_serie = s.id_serie');
    Script.Add('    where');
    Script.Add('      '' || swhere || ''');
    Script.Add('    order by');
    Script.Add('      coalesce(a.titrealbum, s.titreserie), s.titreserie,');
    Script.Add('      a.horsserie nulls first, a.integrale nulls first, a.tome nulls first,');
    Script.Add('      a.tomedebut nulls first, a.tomefin nulls first,');
    Script.Add('      a.anneeparution nulls first, a.moisparution nulls first''');
    Script.Add('    into');
    Script.Add('      :id_album, :titrealbum, :tome, :tomedebut, :tomefin, :horsserie,');
    Script.Add('      :integrale, :moisparution, :anneeparution, :notation, :id_serie,');
    Script.Add('      :titreserie, :achat, :complet');
    Script.Add('  do');
    Script.Add('  begin');
    Script.Add('    suspend;');
    Script.Add('  end');
    Script.Add('end;');

    Script.Add('alter procedure albums_by_genre (');
    Script.Add('    id_genre type of column genres.id_genre,');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    id_album type of column albums.id_album,');
    Script.Add('    titrealbum type of column albums.titrealbum,');
    Script.Add('    tome type of column albums.tome,');
    Script.Add('    tomedebut type of column albums.tomedebut,');
    Script.Add('    tomefin type of column albums.tomefin,');
    Script.Add('    horsserie type of column albums.horsserie,');
    Script.Add('    integrale type of column albums.integrale,');
    Script.Add('    moisparution type of column albums.moisparution,');
    Script.Add('    anneeparution type of column albums.anneeparution,');
    Script.Add('    notation type of column albums.notation,');
    Script.Add('    id_serie type of column series.id_serie,');
    Script.Add('    titreserie type of column series.titreserie,');
    Script.Add('    achat type of column albums.achat,');
    Script.Add('    complet type of column albums.complet)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(200);');
    Script.Add('begin');
    Script.Add('  if (:id_genre = cast('''' as char(38))) then');
    Script.Add('    swhere = ''g.id_genre is null '';');
    Script.Add('  else');
    Script.Add('    swhere = ''g.id_genre = '''''' || :id_genre || '''''' '';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = swhere || ''and '' || filtre || '' '';');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      a.id_album, a.titrealbum, a.tome, a.tomedebut, a.tomefin, a.horsserie,');
    Script.Add('      a.integrale, a.moisparution, a.anneeparution, a.notation, a.id_serie,');
    Script.Add('      a.titreserie, a.achat, a.complet');
    Script.Add('    from');
    Script.Add('      vw_liste_albums a');
    Script.Add('      left join genreseries gs on');
    Script.Add('        gs.id_serie = a.id_serie');
    Script.Add('      left join genres g on');
    Script.Add('        gs.id_genre = g.id_genre');
    Script.Add('    where '' || :swhere || ''');
    Script.Add('    order by');
    Script.Add('      coalesce(a.titrealbum, a.titreserie), a.titreserie,');
    Script.Add('      a.horsserie nulls first, a.integrale nulls first, a.tome nulls first,');
    Script.Add('      a.tomedebut nulls first, a.tomefin nulls first,');
    Script.Add('      a.anneeparution nulls first, a.moisparution nulls first''');
    Script.Add('    into');
    Script.Add('      :id_album, :titrealbum, :tome, :tomedebut, :tomefin, :horsserie,');
    Script.Add('      :integrale, :moisparution, :anneeparution, :notation, :id_serie,');
    Script.Add('      :titreserie, :achat, :complet');
    Script.Add('  do');
    Script.Add('  begin');
    Script.Add('    suspend;');
    Script.Add('  end');
    Script.Add('end;');

    Script.Add('alter procedure albums_by_initiale (');
    Script.Add('    initiale t_initiale,');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    id_album type of column albums.id_album,');
    Script.Add('    titrealbum type of column albums.titrealbum,');
    Script.Add('    tome type of column albums.tome,');
    Script.Add('    tomedebut type of column albums.tomedebut,');
    Script.Add('    tomefin type of column albums.tomefin,');
    Script.Add('    horsserie type of column albums.horsserie,');
    Script.Add('    integrale type of column albums.integrale,');
    Script.Add('    moisparution type of column albums.moisparution,');
    Script.Add('    anneeparution type of column albums.anneeparution,');
    Script.Add('    notation type of column albums.notation,');
    Script.Add('    id_serie type of column series.id_serie,');
    Script.Add('    titreserie type of column series.titreserie,');
    Script.Add('    achat type of column albums.achat,');
    Script.Add('    complet type of column albums.complet)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(133);');
    Script.Add('begin');
    Script.Add('  swhere = '''';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = '' and '' || filtre || '' '';');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      a.id_album, a.titrealbum, a.tome, a.tomedebut, a.tomefin, a.horsserie,');
    Script.Add('      a.integrale, a.moisparution, a.anneeparution, a.notation, a.id_serie,');
    Script.Add('      s.titreserie, a.achat, a.complet');
    Script.Add('    from');
    Script.Add('      albums a');
    Script.Add('      left join series s on');
    Script.Add('        s.id_serie = a.id_serie');
    Script.Add('    where');
    Script.Add('      coalesce(a.initialetitrealbum, s.initialetitreserie) = '''''' ||: initiale || '''''' '' || swhere || ''');
    Script.Add('    order by');
    Script.Add('      coalesce(a.titrealbum, s.titreserie), s.titreserie,');
    Script.Add('      a.horsserie nulls first, a.integrale nulls first, a.tome nulls first,');
    Script.Add('      a.tomedebut nulls first, a.tomefin nulls first,');
    Script.Add('      a.anneeparution nulls first, a.moisparution nulls first''');
    Script.Add('    into');
    Script.Add('      :id_album, :titrealbum, :tome, :tomedebut, :tomefin, :horsserie,');
    Script.Add('      :integrale, :moisparution, :anneeparution, :notation, :id_serie,');
    Script.Add('      :titreserie, :achat, :complet');
    Script.Add('  do');
    Script.Add('  begin');
    Script.Add('    suspend;');
    Script.Add('  end');
    Script.Add('end;');

    Script.Add('alter procedure albums_by_serie (');
    Script.Add('    in_id_serie type of column series.id_serie,');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    id_album type of column albums.id_album,');
    Script.Add('    titrealbum type of column albums.titrealbum,');
    Script.Add('    tome type of column albums.tome,');
    Script.Add('    tomedebut type of column albums.tomedebut,');
    Script.Add('    tomefin type of column albums.tomefin,');
    Script.Add('    horsserie type of column albums.horsserie,');
    Script.Add('    integrale type of column albums.integrale,');
    Script.Add('    moisparution type of column albums.moisparution,');
    Script.Add('    anneeparution type of column albums.anneeparution,');
    Script.Add('    notation type of column albums.notation,');
    Script.Add('    id_serie type of column series.id_serie,');
    Script.Add('    titreserie type of column series.titreserie,');
    Script.Add('    achat type of column albums.achat,');
    Script.Add('    complet type of column albums.complet)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(130);');
    Script.Add('begin');
    Script.Add('  if (:in_id_serie = cast('''' as char(38))) then');
    Script.Add('    swhere = ''id_serie is null '';');
    Script.Add('  else');
    Script.Add('    swhere = ''id_serie = '''''' || :in_id_serie || '''''' '';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = swhere || ''and '' || filtre || '' '';');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      id_album, titrealbum, tome, tomedebut, tomefin, horsserie,');
    Script.Add('      integrale, moisparution, anneeparution, notation, id_serie,');
    Script.Add('      titreserie, achat, complet');
    Script.Add('    from');
    Script.Add('      vw_liste_albums');
    Script.Add('    where');
    Script.Add('      '' || :swhere || ''');
    Script.Add('    order by');
    Script.Add('      horsserie nulls first, integrale nulls first, tome nulls first,');
    Script.Add('      anneeparution nulls first, moisparution nulls first, titrealbum''');
    Script.Add('    into');
    Script.Add('      :id_album, :titrealbum, :tome, :tomedebut, :tomefin, :horsserie,');
    Script.Add('      :integrale, :moisparution, :anneeparution, :notation, :id_serie,');
    Script.Add('      :titreserie, :achat, :complet');
    Script.Add('  do');
    Script.Add('  begin');
    Script.Add('    suspend;');
    Script.Add('  end');
    Script.Add('end;');

    Script.Add('alter procedure albums_manquants (');
    Script.Add('    withintegrale type of t_yesno,');
    Script.Add('    withachat type of t_yesno,');
    Script.Add('    in_idserie type of column series.id_serie)');
    Script.Add('returns (');
    Script.Add('    id_serie type of column series.id_serie,');
    Script.Add('    countserie integer,');
    Script.Add('    titreserie type of column series.titreserie,');
    Script.Add('    tome type of column albums.tome,');
    Script.Add('    id_editeur type of column editeurs.id_editeur,');
    Script.Add('    nomediteur type of column editeurs.nomediteur,');
    Script.Add('    id_collection type of column collections.id_collection,');
    Script.Add('    nomcollection type of column collections.nomcollection,');
    Script.Add('    achat type of column albums.achat)');
    Script.Add('as');
    Script.Add('declare variable maxserie integer;');
    Script.Add('declare variable nb_albums integer;');
    Script.Add('declare variable currenttome integer;');
    Script.Add('declare variable ownedtome integer;');
    Script.Add('declare variable sumachat integer;');
    Script.Add('begin');
    Script.Add('  if (withintegrale is null) then withintegrale = 1;');
    Script.Add('  if (withachat is null) then withachat = 1;');
    Script.Add('  for');
    Script.Add('    select');
    Script.Add('      s.id_serie, s.nb_albums, max(a.tome), count(distinct a.tome),');
    Script.Add('      cast(sum(a.achat) as integer),');
    Script.Add('      e.id_editeur, e.nomediteur, c.id_collection, c.nomcollection');
    Script.Add('    from');
    Script.Add('      liste_tomes(:withintegrale, :in_idserie) a');
    Script.Add('      /* pas de left join: on cherche les manquants pour compléter les séries */');
    Script.Add('      inner join series s on');
    Script.Add('        a.id_serie = s.id_serie');
    Script.Add('      left join editeurs e on');
    Script.Add('        s.id_editeur = e.id_editeur');
    Script.Add('      left join collections c on');
    Script.Add('        s.id_collection = c.id_collection');
    Script.Add('    where');
    Script.Add('      s.suivremanquants = 1');
    Script.Add('    group by');
    Script.Add('      s.id_serie, s.titreserie, e.nomediteur, c.nomcollection,');
    Script.Add('      e.id_editeur, c.id_collection, s.nb_albums');
    Script.Add('    order by');
    Script.Add('      s.titreserie, e.nomediteur, c.nomcollection');
    Script.Add('    into');
    Script.Add('      :id_serie, :nb_albums, :maxserie, :countserie,');
    Script.Add('      :sumachat,');
    Script.Add('      :id_editeur, :nomediteur, :id_collection, :nomcollection');
    Script.Add('  do');
    Script.Add('  begin');
    Script.Add('    if (withachat = 0) then');
    Script.Add('      countserie = :countserie - :sumachat;');
    Script.Add('    if (nb_albums is not null and nb_albums > 0 and nb_albums > maxserie) then');
    Script.Add('      maxserie = :nb_albums;');
    Script.Add('    if (countserie <> maxserie) then');
    Script.Add('    begin');
    Script.Add('      currenttome = 0;');
    Script.Add('      for');
    Script.Add('        select distinct');
    Script.Add('          titreserie, tome, achat');
    Script.Add('        from');
    Script.Add('          liste_tomes(:withintegrale, :id_serie) a');
    Script.Add('          inner join series s on');
    Script.Add('            a.id_serie = s.id_serie');
    Script.Add('        order by');
    Script.Add('          tome');
    Script.Add('        into');
    Script.Add('          :titreserie, :ownedtome, :achat');
    Script.Add('      do');
    Script.Add('      begin');
    Script.Add('        currenttome = currenttome + 1;');
    Script.Add('        while ((currenttome <> ownedtome) and (currenttome < maxserie)) do');
    Script.Add('        begin');
    Script.Add('          tome = currenttome;');
    Script.Add('          suspend;');
    Script.Add('          currenttome = currenttome + 1;');
    Script.Add('        end');
    Script.Add('        if ((withachat = 0) and (achat = 1)) then');
    Script.Add('        begin');
    Script.Add('          tome = ownedtome;');
    Script.Add('          suspend;');
    Script.Add('        end');
    Script.Add('      end');
    Script.Add('      currenttome = currenttome + 1;');
    Script.Add('      while (currenttome <= maxserie) do');
    Script.Add('      begin');
    Script.Add('        tome = currenttome;');
    Script.Add('        suspend;');
    Script.Add('        currenttome = currenttome + 1;');
    Script.Add('      end');
    Script.Add('    end');
    Script.Add('  end');
    Script.Add('');
    Script.Add('  /* on ne peut pas utiliser un "union": le order by de la première requête');
    Script.Add('     est impératif */');
    Script.Add('  countserie = 0;');
    Script.Add('  achat = null;');
    Script.Add('  for');
    Script.Add('    select');
    Script.Add('      s.id_serie, s.titreserie, s.nb_albums,');
    Script.Add('      e.id_editeur, e.nomediteur, c.id_collection, c.nomcollection');
    Script.Add('    from');
    Script.Add('      series s');
    Script.Add('      left join editeurs e on');
    Script.Add('        s.id_editeur = e.id_editeur');
    Script.Add('      left join collections c on');
    Script.Add('        s.id_collection = c.id_collection');
    Script.Add('    where');
    Script.Add('      not exists (select 1 from liste_tomes(:withintegrale, s.id_serie))');
    Script.Add('      and s.suivremanquants = 1 and s.nb_albums is not null');
    Script.Add('      and (:in_idserie is null or id_serie = :in_idserie)');
    Script.Add('    into');
    Script.Add('      :id_serie, :titreserie, :nb_albums,');
    Script.Add('      :id_editeur, :nomediteur, :id_collection, :nomcollection');
    Script.Add('  do begin');
    Script.Add('    currenttome = 1;');
    Script.Add('    while (currenttome <= nb_albums) do');
    Script.Add('    begin');
    Script.Add('      tome = currenttome;');
    Script.Add('      suspend;');
    Script.Add('      currenttome = currenttome + 1;');
    Script.Add('    end');
    Script.Add('  end');
    Script.Add('end;');

    Script.Add('alter procedure annees_albums (');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    anneeparution type of column albums.anneeparution,');
    Script.Add('    countannee integer)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(133);');
    Script.Add('begin');
    Script.Add('  swhere = '''';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = ''and '' || filtre;');
    Script.Add('');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      cast(-1 as smallint), count(id_album)');
    Script.Add('    from');
    Script.Add('      vw_liste_albums');
    Script.Add('    where');
    Script.Add('      anneeparution is null '' || swhere || ''');
    Script.Add('    group by');
    Script.Add('      anneeparution''');
    Script.Add('  into');
    Script.Add('    :anneeparution, :countannee');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      anneeparution, count(id_album)');
    Script.Add('    from');
    Script.Add('      vw_liste_albums');
    Script.Add('    where');
    Script.Add('      anneeparution is not null '' || swhere || ''');
    Script.Add('    group by');
    Script.Add('      anneeparution''');
    Script.Add('  into');
    Script.Add('    :anneeparution, :countannee');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('end;');

    Script.Add('alter procedure calcul_annee_sortie (');
    Script.Add('    withachat t_yesno,');
    Script.Add('    in_idserie type of column series.id_serie,');
    Script.Add('    sommeponderee integer,');
    Script.Add('    comptealbum integer,');
    Script.Add('    maxtome type of column albums.tome,');
    Script.Add('    maxannee type of column albums.anneeparution,');
    Script.Add('    maxmois type of column albums.moisparution)');
    Script.Add('returns (');
    Script.Add('    id_serie type of column series.id_serie,');
    Script.Add('    titreserie type of column series.titreserie,');
    Script.Add('    tome type of column albums.tome,');
    Script.Add('    anneeparution type of column albums.anneeparution,');
    Script.Add('    moisparution type of column albums.moisparution,');
    Script.Add('    id_editeur type of column editeurs.id_editeur,');
    Script.Add('    nomediteur type of column editeurs.nomediteur,');
    Script.Add('    id_collection type of column collections.id_collection,');
    Script.Add('    nomcollection type of column collections.nomcollection)');
    Script.Add('as');
    Script.Add('declare variable maxtome2 integer;');
    Script.Add('begin');
    Script.Add('  tome = maxtome + 1;');
    Script.Add('');
    Script.Add('  select');
    Script.Add('    cast(max(tomefin) + 1 as integer)');
    Script.Add('  from');
    Script.Add('    albums');
    Script.Add('  where');
    Script.Add('    horsserie = 0 and integrale = 1');
    Script.Add('    and id_serie = :in_idserie and (:withachat = 1 or achat = 0)');
    Script.Add('  into');
    Script.Add('    :maxtome2;');
    Script.Add('');
    Script.Add('  if (maxtome2 > tome) then tome = maxtome2;');
    Script.Add('');
    Script.Add('  select');
    Script.Add('    s.id_serie, s.titreserie,');
    Script.Add('    e.id_editeur, e.nomediteur,');
    Script.Add('    c.id_collection, c.nomcollection');
    Script.Add('  from');
    Script.Add('    series s');
    Script.Add('    left join editeurs e on');
    Script.Add('      e.id_editeur = s.id_editeur');
    Script.Add('    left join collections c on');
    Script.Add('      c.id_collection = s.id_collection');
    Script.Add('  where');
    Script.Add('    s.id_serie = :in_idserie');
    Script.Add('  into');
    Script.Add('    :id_serie, :titreserie,');
    Script.Add('    :id_editeur, :nomediteur,');
    Script.Add('    :id_collection, :nomcollection;');
    Script.Add('');
    Script.Add('  if (maxmois is null) then');
    Script.Add('  begin');
    Script.Add('    anneeparution = maxannee + ((tome - maxtome) * ((sommeponderee / 12) / comptealbum));');
    Script.Add('    moisparution = null;');
    Script.Add('  end');
    Script.Add('  else');
    Script.Add('  begin');
    Script.Add('    moisparution = maxmois + ((tome - maxtome) * (sommeponderee / comptealbum));');
    Script.Add('    anneeparution = maxannee;');
    Script.Add('    while (moisparution > 12) do');
    Script.Add('    begin');
    Script.Add('      moisparution = moisparution - 12;');
    Script.Add('      anneeparution = anneeparution + 1;');
    Script.Add('    end');
    Script.Add('  end');
    Script.Add('');
    Script.Add('  suspend;');
    Script.Add('end;');

    Script.Add('alter procedure collections_albums (');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    nomcollection type of column collections.nomcollection,');
    Script.Add('    countcollection integer,');
    Script.Add('    id_collection type of column collections.id_collection,');
    Script.Add('    nomediteur type of column editeurs.nomediteur,');
    Script.Add('    id_editeur type of column editeurs.id_editeur)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(133);');
    Script.Add('begin');
    Script.Add('  swhere = '''';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = ''and '' || filtre;');
    Script.Add('');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      cast(''''-1'''' as varchar(50)), count(id_album), null, null, null');
    Script.Add('    from');
    Script.Add('      vw_liste_collections_albums');
    Script.Add('    where');
    Script.Add('      id_collection is null '' || swhere || ''');
    Script.Add('    group by');
    Script.Add('      nomcollection, id_collection''');
    Script.Add('    into');
    Script.Add('      :nomcollection, :countcollection, :id_collection, :nomediteur, :id_editeur');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      nomcollection, count(id_album), id_collection, nomediteur, id_editeur');
    Script.Add('    from');
    Script.Add('      vw_liste_collections_albums');
    Script.Add('    where');
    Script.Add('      id_collection is not null '' || swhere || ''');
    Script.Add('    group by');
    Script.Add('      nomcollection, id_collection, nomediteur, id_editeur''');
    Script.Add('    into');
    Script.Add('      :nomcollection, :countcollection, :id_collection, :nomediteur, :id_editeur');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('end;');

    Script.Add('alter procedure collections_by_initiale (');
    Script.Add('    initiale t_initiale,');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    id_collection type of column collections.id_collection,');
    Script.Add('    nomcollection type of column collections.nomcollection,');
    Script.Add('    id_editeur type of column editeurs.id_editeur,');
    Script.Add('    nomediteur type of column editeurs.nomediteur)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(133);');
    Script.Add('begin');
    Script.Add('  swhere = '''';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = ''and '' || filtre || '' '';');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      id_collection, nomcollection, id_editeur, nomediteur');
    Script.Add('    from');
    Script.Add('      vw_liste_collections');
    Script.Add('    where');
    Script.Add('      initialenomcollection = '''''' || :initiale || '''''' '' || swhere || ''');
    Script.Add('    order by');
    Script.Add('      nomcollection''');
    Script.Add('    into');
    Script.Add('      :id_collection, :nomcollection, :id_editeur, :nomediteur');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('end;');

    Script.Add('alter procedure deletefile (');
    Script.Add('    fichier varchar(255))');
    Script.Add('returns (');
    Script.Add('    result integer)');
    Script.Add('as');
    Script.Add('begin');
    Script.Add('  select udf_deletefile(:fichier) from rdb$database into :result;');
    Script.Add('  suspend;');
    Script.Add('end;');

    Script.Add('alter procedure directorycontent (');
    Script.Add('    chemin varchar(255),');
    Script.Add('    searchattr integer)');
    Script.Add('returns (');
    Script.Add('    searchrec integer,');
    Script.Add('    filename varchar(255),');
    Script.Add('    filesize integer,');
    Script.Add('    fileattr integer)');
    Script.Add('as');
    Script.Add('begin');
    Script.Add('  select udf_findfilefirst(:chemin, :searchattr) from rdb$database into :searchrec;');
    Script.Add('  if (searchrec < 0) then');
    Script.Add('    suspend;');
    Script.Add('  else while (searchrec > 0) do begin');
    Script.Add('    select');
    Script.Add('      cast(udf_extractfilename(:searchrec) as varchar(255)),');
    Script.Add('      udf_extractfilesize(:searchrec),');
    Script.Add('      udf_extractfileattr(:searchrec)');
    Script.Add('    from rdb$database');
    Script.Add('    into');
    Script.Add('      :filename,');
    Script.Add('      :filesize,');
    Script.Add('      :fileattr;');
    Script.Add('    select udf_findfilenext(:searchrec) from rdb$database into :searchrec;');
    Script.Add('    suspend;');
    Script.Add('  end');
    Script.Add('end;');

    Script.Add('alter procedure editeurs_achatalbums (');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    nomediteur type of column editeurs.nomediteur,');
    Script.Add('    countediteur integer,');
    Script.Add('    id_editeur type of column editeurs.id_editeur)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(133);');
    Script.Add('begin');
    Script.Add('  swhere = '''';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = ''and '' || filtre;');
    Script.Add('');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      cast(''''-1'''' as varchar(50)), count(id_album), null');
    Script.Add('    from');
    Script.Add('      vw_liste_editeurs_achatalbums');
    Script.Add('    where');
    Script.Add('      id_editeur is null '' || swhere || ''');
    Script.Add('    group by');
    Script.Add('      nomediteur, id_editeur''');
    Script.Add('    into');
    Script.Add('      :nomediteur, :countediteur, :id_editeur');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      nomediteur, count(id_album), id_editeur');
    Script.Add('    from');
    Script.Add('      vw_liste_editeurs_achatalbums');
    Script.Add('    where');
    Script.Add('      id_editeur is not null '' || swhere || ''');
    Script.Add('    group by');
    Script.Add('      nomediteur, id_editeur''');
    Script.Add('    into');
    Script.Add('      :nomediteur, :countediteur, :id_editeur');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('end;');

    Script.Add('alter procedure editeurs_albums (');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    nomediteur type of column editeurs.nomediteur,');
    Script.Add('    countediteur integer,');
    Script.Add('    id_editeur type of column editeurs.id_editeur)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(133);');
    Script.Add('begin');
    Script.Add('  swhere = '''';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = ''and '' || filtre;');
    Script.Add('');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      cast(''''-1'''' as varchar(50)), count(id_album), null');
    Script.Add('    from');
    Script.Add('      vw_liste_editeurs_albums');
    Script.Add('    where');
    Script.Add('      id_editeur is null '' || swhere || ''');
    Script.Add('    group by');
    Script.Add('      nomediteur, id_editeur''');
    Script.Add('    into');
    Script.Add('      :nomediteur, :countediteur, :id_editeur');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      nomediteur, count(id_album), id_editeur');
    Script.Add('    from');
    Script.Add('      vw_liste_editeurs_albums');
    Script.Add('    where');
    Script.Add('      id_editeur is not null '' || swhere || ''');
    Script.Add('    group by');
    Script.Add('      nomediteur, id_editeur''');
    Script.Add('    into');
    Script.Add('      :nomediteur, :countediteur, :id_editeur');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('end;');

    Script.Add('alter procedure editeurs_by_initiale (');
    Script.Add('    initiale t_initiale)');
    Script.Add('returns (');
    Script.Add('    id_editeur type of column editeurs.id_editeur,');
    Script.Add('    nomediteur type of column editeurs.nomediteur)');
    Script.Add('as');
    Script.Add('begin');
    Script.Add('  for');
    Script.Add('    select');
    Script.Add('      id_editeur, nomediteur');
    Script.Add('    from');
    Script.Add('      editeurs');
    Script.Add('    where');
    Script.Add('      initialenomediteur = :initiale');
    Script.Add('    order by');
    Script.Add('      nomediteur');
    Script.Add('    into');
    Script.Add('      :id_editeur, :nomediteur');
    Script.Add('  do');
    Script.Add('  begin');
    Script.Add('    suspend;');
    Script.Add('  end');
    Script.Add('end;');

    Script.Add('alter procedure emprunteurs_by_initiale (');
    Script.Add('    initiale t_initiale)');
    Script.Add('returns (');
    Script.Add('    id_emprunteur type of column emprunteurs.id_emprunteur,');
    Script.Add('    nomemprunteur type of column emprunteurs.nomemprunteur)');
    Script.Add('as');
    Script.Add('begin');
    Script.Add('  for');
    Script.Add('    select');
    Script.Add('      id_emprunteur, nomemprunteur');
    Script.Add('    from');
    Script.Add('      emprunteurs');
    Script.Add('    where');
    Script.Add('      initialenomemprunteur = :initiale');
    Script.Add('    order by');
    Script.Add('      nomemprunteur');
    Script.Add('    into');
    Script.Add('      :id_emprunteur, :nomemprunteur');
    Script.Add('  do');
    Script.Add('  begin');
    Script.Add('    suspend;');
    Script.Add('  end');
    Script.Add('end;');

    Script.Add('alter procedure genres_albums (');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    genre type of column genres.genre,');
    Script.Add('    countgenre integer,');
    Script.Add('    id_genre type of column genres.id_genre)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(132);');
    Script.Add('begin');
    Script.Add('  swhere = '''';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = ''and '' || filtre;');
    Script.Add('');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      cast(''''-1'''' as varchar(30)), count(id_album), null');
    Script.Add('    from');
    Script.Add('      vw_liste_genres_albums');
    Script.Add('    where');
    Script.Add('      id_genre is null '' || swhere || ''');
    Script.Add('    group by');
    Script.Add('      genre, id_genre''');
    Script.Add('    into');
    Script.Add('      :genre, :countgenre, :id_genre');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      genre, count(id_album), id_genre');
    Script.Add('    from');
    Script.Add('      vw_liste_genres_albums');
    Script.Add('    where');
    Script.Add('      id_genre is not null '' || swhere || ''');
    Script.Add('    group by');
    Script.Add('      genre, id_genre''');
    Script.Add('    into');
    Script.Add('      :genre, :countgenre, :id_genre');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('end;');

    Script.Add('alter procedure genres_by_initiale (');
    Script.Add('    initiale t_initiale)');
    Script.Add('returns (');
    Script.Add('    id_genre type of column genres.id_genre,');
    Script.Add('    genre type of column genres.genre)');
    Script.Add('as');
    Script.Add('begin');
    Script.Add('  for');
    Script.Add('    select');
    Script.Add('      id_genre, genre');
    Script.Add('    from');
    Script.Add('      genres');
    Script.Add('    where');
    Script.Add('      initialegenre = :initiale');
    Script.Add('    order by');
    Script.Add('      genre');
    Script.Add('    into');
    Script.Add('      :id_genre, :genre');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('end;');

    Script.Add('alter procedure get_initiale (');
    Script.Add('    chaine varchar(150) character set iso8859_1)');
    Script.Add('returns (');
    Script.Add('    initiale t_initiale)');
    Script.Add('as');
    Script.Add('begin');
    Script.Add('  initiale = upper(cast(substring(:chaine from 1 for 1) as char(1)));');
    Script.Add('  if (not (initiale between ''a'' and ''z'' or initiale between ''0'' and ''9'')) then');
    Script.Add('    initiale = ''#'';');
    Script.Add('  suspend;');
    Script.Add('end;');

    Script.Add('alter procedure initiales_albums (');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    initialetitrealbum type of column albums.initialetitrealbum,');
    Script.Add('    countinitiale integer)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(133);');
    Script.Add('begin');
    Script.Add('  swhere = '''';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = ''where '' || filtre;');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      coalesce(initialetitrealbum, initialetitreserie), count(id_album)');
    Script.Add('    from');
    Script.Add('      albums');
    Script.Add('      left join series on');
    Script.Add('        albums.id_serie = series.id_serie '' || swhere || ''');
    Script.Add('    group by');
    Script.Add('      1''');
    Script.Add('    into');
    Script.Add('      :initialetitrealbum, :countinitiale');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('end;');

    Script.Add('alter procedure initiales_collections (');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    initialenomcollection type of column collections.initialenomcollection,');
    Script.Add('    countinitiale integer)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(133);');
    Script.Add('begin');
    Script.Add('  swhere = '''';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = ''where '' || filtre;');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      initialenomcollection, count(id_collection)');
    Script.Add('    from');
    Script.Add('      collections '' || swhere || ''');
    Script.Add('    group by');
    Script.Add('      initialenomcollection''');
    Script.Add('    into');
    Script.Add('      :initialenomcollection, :countinitiale');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('end;');

    Script.Add('alter procedure liste_tomes (');
    Script.Add('    withintegrale t_yesno,');
    Script.Add('    in_idserie type of column series.id_serie)');
    Script.Add('returns (');
    Script.Add('    id_serie type of column series.id_serie,');
    Script.Add('    tome type of column albums.tome,');
    Script.Add('    integrale type of column albums.integrale,');
    Script.Add('    achat type of column albums.achat)');
    Script.Add('as');
    Script.Add('declare variable tomedebut type of column albums.tomedebut;');
    Script.Add('declare variable tomefin type of column albums.tomefin;');
    Script.Add('begin');
    Script.Add('  for');
    Script.Add('    select');
    Script.Add('      id_serie, tome, integrale, achat');
    Script.Add('    from');
    Script.Add('      albums');
    Script.Add('    where');
    Script.Add('      tome is not null and integrale = 0 and horsserie = 0');
    Script.Add('      and (:in_idserie is null or id_serie = :in_idserie)');
    Script.Add('    order by');
    Script.Add('      id_serie, tome');
    Script.Add('    into');
    Script.Add('      :id_serie, :tome, :integrale, :achat');
    Script.Add('    do');
    Script.Add('      suspend;');
    Script.Add('');
    Script.Add('  if (withintegrale is null) then withintegrale = 1;');
    Script.Add('  if (withintegrale = 1) then');
    Script.Add('    for');
    Script.Add('      select');
    Script.Add('        id_serie, tomedebut, tomefin, integrale, achat');
    Script.Add('      from');
    Script.Add('        albums');
    Script.Add('      where');
    Script.Add('        tomedebut is not null and tomefin is not null');
    Script.Add('        and integrale = 1 and horsserie = 0');
    Script.Add('        and (:in_idserie is null or id_serie = :in_idserie)');
    Script.Add('      order by');
    Script.Add('        id_serie, tomedebut, tomefin');
    Script.Add('      into');
    Script.Add('        :id_serie, :tomedebut, :tomefin, :integrale, :achat');
    Script.Add('      do');
    Script.Add('      begin');
    Script.Add('        tome = tomedebut - 1;');
    Script.Add('        while (tome <> tomefin) do');
    Script.Add('        begin');
    Script.Add('          tome = tome + 1;');
    Script.Add('          suspend;');
    Script.Add('        end');
    Script.Add('      end');
    Script.Add('end;');

    Script.Add('alter procedure loadblobfromfile (');
    Script.Add('    chemin varchar(255),');
    Script.Add('    fichier varchar(255))');
    Script.Add('returns (');
    Script.Add('    blobcontent blob sub_type 0 segment size 80)');
    Script.Add('as');
    Script.Add('begin');
    Script.Add('  select udf_loadblobfromfile(:chemin, :fichier) from rdb$database into :blobcontent;');
    Script.Add('  suspend;');
    Script.Add('end;');

    Script.Add('alter procedure parabd_by_serie (');
    Script.Add('    in_id_serie type of column series.id_serie,');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    id_parabd type of column parabd.id_parabd,');
    Script.Add('    titreparabd type of column parabd.titreparabd,');
    Script.Add('    id_serie type of column series.id_serie,');
    Script.Add('    titreserie type of column series.titreserie,');
    Script.Add('    achat type of column albums.achat,');
    Script.Add('    complet type of column albums.complet,');
    Script.Add('    scategorie type of column listes.libelle)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(130);');
    Script.Add('begin');
    Script.Add('  if (:in_id_serie = cast('''' as char(38))) then');
    Script.Add('    swhere = ''id_serie is null '';');
    Script.Add('  else');
    Script.Add('    swhere = ''id_serie = '''''' || :in_id_serie || '''''' '';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = swhere || ''and '' || filtre || '' '';');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      id_parabd, titreparabd, id_parabd, titreserie, achat, complet,');
    Script.Add('      scategorie');
    Script.Add('    from');
    Script.Add('      vw_liste_parabd');
    Script.Add('    where');
    Script.Add('      '' || :swhere || ''');
    Script.Add('    order by');
    Script.Add('      titreparabd''');
    Script.Add('    into');
    Script.Add('      :id_parabd, :titreparabd, :id_serie, :titreserie, :achat, :complet,');
    Script.Add('      :scategorie');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('end;');

    Script.Add('alter procedure personnes_by_initiale (');
    Script.Add('    initiale t_initiale)');
    Script.Add('returns (');
    Script.Add('    id_personne type of column personnes.id_personne,');
    Script.Add('    nompersonne type of column personnes.nompersonne)');
    Script.Add('as');
    Script.Add('begin');
    Script.Add('  for');
    Script.Add('    select');
    Script.Add('      id_personne, nompersonne');
    Script.Add('    from');
    Script.Add('      personnes');
    Script.Add('    where');
    Script.Add('      initialenompersonne = :initiale');
    Script.Add('    order by');
    Script.Add('      nompersonne');
    Script.Add('    into');
    Script.Add('      :id_personne, :nompersonne');
    Script.Add('  do');
    Script.Add('  begin');
    Script.Add('    suspend;');
    Script.Add('  end');
    Script.Add('end;');

    Script.Add('alter procedure previsions_sorties (');
    Script.Add('    withachat t_yesno,');
    Script.Add('    in_id_serie type of column series.id_serie)');
    Script.Add('returns (');
    Script.Add('    id_serie type of column series.id_serie,');
    Script.Add('    titreserie type of column series.titreserie,');
    Script.Add('    tome type of column albums.tome,');
    Script.Add('    anneeparution type of column albums.anneeparution,');
    Script.Add('    moisparution type of column albums.moisparution,');
    Script.Add('    id_editeur type of column editeurs.id_editeur,');
    Script.Add('    nomediteur type of column editeurs.nomediteur,');
    Script.Add('    id_collection type of column collections.id_collection,');
    Script.Add('    nomcollection type of column collections.nomcollection)');
    Script.Add('as');
    Script.Add('declare variable currentidserie type of column series.id_serie;');
    Script.Add('declare variable oldidserie type of column series.id_serie;');
    Script.Add('declare variable currenttome type of column albums.tome;');
    Script.Add('declare variable sommeponderee integer;');
    Script.Add('declare variable comptealbum integer;');
    Script.Add('declare variable currentannee type of column albums.anneeparution;');
    Script.Add('declare variable currentmois type of column albums.moisparution;');
    Script.Add('declare variable tomeprecedent type of column albums.tome;');
    Script.Add('declare variable anneeprecedente type of column albums.anneeparution;');
    Script.Add('declare variable moisprecedent type of column albums.moisparution;');
    Script.Add('declare variable diffmois integer;');
    Script.Add('begin');
    Script.Add('  if (withachat is null) then withachat = 1;');
    Script.Add('  oldidserie = null;');
    Script.Add('  tomeprecedent = -1;');
    Script.Add('  anneeprecedente = -1;');
    Script.Add('  moisprecedent = null;');
    Script.Add('  for');
    Script.Add('    select');
    Script.Add('      tome, anneeparution, moisparution, s.id_serie');
    Script.Add('    from');
    Script.Add('      albums a');
    Script.Add('      /* pas de left join: on calcul les prévisions de sorties des nouveautés des séries */');
    Script.Add('      inner join series s on');
    Script.Add('        s.id_serie = a.id_serie');
    Script.Add('    where');
    Script.Add('      s.suivresorties = 1');
    Script.Add('      and a.horsserie = 0 and a.integrale = 0 and a.anneeparution is not null');
    Script.Add('      and (:in_id_serie is null or s.id_serie = :in_id_serie)');
    Script.Add('      and (:withachat = 1 or achat = 0)');
    Script.Add('    order by');
    Script.Add('      s.id_serie, tome');
    Script.Add('    into');
    Script.Add('      :currenttome, :currentannee, :currentmois, :currentidserie');
    Script.Add('  do');
    Script.Add('  begin');
    Script.Add('    if (oldidserie is null or currentidserie <> oldidserie) then');
    Script.Add('    begin');
    Script.Add('');
    Script.Add('      if (oldidserie is not null and comptealbum > 0) then');
    Script.Add('      begin');
    Script.Add('        select');
    Script.Add('          id_serie, titreserie, tome, anneeparution, moisparution,');
    Script.Add('          id_editeur, nomediteur, id_collection, nomcollection');
    Script.Add('        from');
    Script.Add('          calcul_annee_sortie(');
    Script.Add('            :withachat, :oldidserie, :sommeponderee, :comptealbum,');
    Script.Add('            :tomeprecedent, :anneeprecedente, :moisprecedent');
    Script.Add('          )');
    Script.Add('        into');
    Script.Add('          :id_serie, :titreserie, :tome, :anneeparution, :moisparution,');
    Script.Add('          :id_editeur, :nomediteur, :id_collection, :nomcollection;');
    Script.Add('');
    Script.Add('        suspend;');
    Script.Add('      end');
    Script.Add('');
    Script.Add('      oldidserie = currentidserie;');
    Script.Add('      sommeponderee = 0;');
    Script.Add('      comptealbum = 0;');
    Script.Add('      tomeprecedent = -1;');
    Script.Add('      anneeprecedente = -1;');
    Script.Add('      moisprecedent = -1;');
    Script.Add('    end');
    Script.Add('    if (tomeprecedent <> -1 and currenttome - tomeprecedent <> 0) then');
    Script.Add('    begin');
    Script.Add('      if (currentmois is null or moisprecedent is null) then');
    Script.Add('        diffmois = 0;');
    Script.Add('      else');
    Script.Add('        diffmois = currentmois - moisprecedent;');
    Script.Add('      /* non pondéré: sommeponderee = sommeponderee + (((currentannee - anneeprecedente) * 12 + (coalesce(currentmois, 1) - coalesce(moisprecedent, 1))) / (currenttome - tomeprecedent)); */');
    Script.Add('      sommeponderee = sommeponderee + (((currentannee - anneeprecedente) * 12 + diffmois) / (currenttome - tomeprecedent)) * currenttome;');
    Script.Add('      /* non pondéré: comptealbum = comptealbum + 1;*/');
    Script.Add('      comptealbum = comptealbum + currenttome;');
    Script.Add('    end');
    Script.Add('    tomeprecedent = currenttome;');
    Script.Add('    anneeprecedente = currentannee;');
    Script.Add('    moisprecedent = currentmois;');
    Script.Add('  end');
    Script.Add('');
    Script.Add('  if (oldidserie is not null and comptealbum > 0) then');
    Script.Add('  begin');
    Script.Add('    select');
    Script.Add('      id_serie, titreserie, tome, anneeparution, moisparution,');
    Script.Add('      id_editeur, nomediteur, id_collection, nomcollection');
    Script.Add('    from');
    Script.Add('      calcul_annee_sortie(');
    Script.Add('        :withachat, :oldidserie, :sommeponderee, :comptealbum, :tomeprecedent,');
    Script.Add('        :anneeprecedente, :moisprecedent');
    Script.Add('      )');
    Script.Add('    into');
    Script.Add('      :id_serie, :titreserie, :tome, :anneeparution, :moisparution,');
    Script.Add('      :id_editeur, :nomediteur, :id_collection, :nomcollection;');
    Script.Add('');
    Script.Add('    suspend;');
    Script.Add('  end');
    Script.Add('end;');

    Script.Add('alter procedure proc_ajoutmvt (');
    Script.Add('    id_edition type of column editions.id_edition,');
    Script.Add('    id_emprunteur type of column emprunteurs.id_emprunteur,');
    Script.Add('    dateemprunt timestamp,');
    Script.Add('    pret type of column statut.pretemprunt)');
    Script.Add('as');
    Script.Add('begin');
    Script.Add('  insert into statut (');
    Script.Add('    dateemprunt, id_emprunteur, id_edition, pretemprunt');
    Script.Add('  ) values (');
    Script.Add('    :dateemprunt, :id_emprunteur, :id_edition, :pret');
    Script.Add('  );');
    Script.Add('');
    Script.Add('  update editions set');
    Script.Add('    prete = :pret');
    Script.Add('  where');
    Script.Add('    id_edition = :id_edition;');
    Script.Add('end;');

    Script.Add('alter procedure proc_auteurs (');
    Script.Add('    album type of column albums.id_album,');
    Script.Add('    serie type of column series.id_serie,');
    Script.Add('    parabd type of column parabd.id_parabd)');
    Script.Add('returns (');
    Script.Add('    id_personne type of column personnes.id_personne,');
    Script.Add('    nompersonne type of column personnes.nompersonne,');
    Script.Add('    id_album type of column albums.id_album,');
    Script.Add('    id_serie type of column series.id_serie,');
    Script.Add('    id_parabd type of column parabd.id_parabd,');
    Script.Add('    metier type of column auteurs.metier)');
    Script.Add('as');
    Script.Add('begin');
    Script.Add('  if (album is not null) then');
    Script.Add('    for');
    Script.Add('      select');
    Script.Add('        p.id_personne, p.nompersonne,');
    Script.Add('        a.id_album, null, null, a.metier');
    Script.Add('      from');
    Script.Add('        personnes p');
    Script.Add('        inner join auteurs a on');
    Script.Add('          a.id_personne = p.id_personne');
    Script.Add('      where');
    Script.Add('        a.id_album = :album');
    Script.Add('      order by');
    Script.Add('        a.metier, p.nompersonne');
    Script.Add('      into');
    Script.Add('        :id_personne, :nompersonne,');
    Script.Add('        :id_album, :id_serie, :id_parabd, :metier');
    Script.Add('    do');
    Script.Add('      suspend;');
    Script.Add('');
    Script.Add('  if (serie is not null) then');
    Script.Add('    for');
    Script.Add('      select');
    Script.Add('        p.id_personne, p.nompersonne,');
    Script.Add('        null, a.id_serie, null, a.metier');
    Script.Add('      from');
    Script.Add('        personnes p');
    Script.Add('        inner join auteurs_series a on');
    Script.Add('          a.id_personne = p.id_personne');
    Script.Add('      where');
    Script.Add('        a.id_serie = :serie');
    Script.Add('      order by');
    Script.Add('        a.metier, p.nompersonne');
    Script.Add('      into');
    Script.Add('        :id_personne, :nompersonne,');
    Script.Add('        :id_album, :id_serie, :id_parabd, :metier');
    Script.Add('    do');
    Script.Add('      suspend;');
    Script.Add('');
    Script.Add('  if (parabd is not null) then');
    Script.Add('    for');
    Script.Add('      select');
    Script.Add('        p.id_personne, p.nompersonne,');
    Script.Add('        null, null, a.id_parabd, cast(null as smallint)');
    Script.Add('      from');
    Script.Add('        personnes p');
    Script.Add('        inner join auteurs_parabd a on');
    Script.Add('          a.id_personne = p.id_personne');
    Script.Add('      where');
    Script.Add('        a.id_parabd = :parabd');
    Script.Add('      order by');
    Script.Add('        p.nompersonne');
    Script.Add('      into');
    Script.Add('        :id_personne, :nompersonne,');
    Script.Add('        :id_album, :id_serie, :id_parabd, :metier');
    Script.Add('    do');
    Script.Add('      suspend;');
    Script.Add('end;');

    Script.Add('alter procedure proc_emprunts');
    Script.Add('returns (');
    Script.Add('    id_edition type of column editions.id_edition,');
    Script.Add('    id_album type of column albums.id_album,');
    Script.Add('    titrealbum type of column albums.titrealbum,');
    Script.Add('    id_serie type of column series.id_serie,');
    Script.Add('    titreserie type of column series.titreserie,');
    Script.Add('    prete type of column editions.prete,');
    Script.Add('    id_emprunteur type of column emprunteurs.id_emprunteur,');
    Script.Add('    nomemprunteur type of column emprunteurs.nomemprunteur,');
    Script.Add('    pretemprunt type of column statut.pretemprunt,');
    Script.Add('    dateemprunt type of column statut.dateemprunt)');
    Script.Add('as');
    Script.Add('begin');
    Script.Add('  for');
    Script.Add('    select');
    Script.Add('      ed.id_edition, a.id_album, a.titrealbum, a.id_serie, a.titreserie,');
    Script.Add('      ed.prete, e.id_emprunteur, e.nomemprunteur, s.pretemprunt,');
    Script.Add('      s.dateemprunt');
    Script.Add('    from');
    Script.Add('      vw_liste_albums a');
    Script.Add('      inner join editions ed on');
    Script.Add('        a.id_album = ed.id_album');
    Script.Add('      inner join statut s on');
    Script.Add('        ed.id_edition = s.id_edition');
    Script.Add('      inner join emprunteurs e on');
    Script.Add('        e.id_emprunteur = s.id_emprunteur');
    Script.Add('    order by');
    Script.Add('      s.dateemprunt desc');
    Script.Add('    into');
    Script.Add('      :id_edition, :id_album, :titrealbum, :id_serie, :titreserie,');
    Script.Add('      :prete, :id_emprunteur, :nomemprunteur, :pretemprunt,');
    Script.Add('      :dateemprunt');
    Script.Add('  do');
    Script.Add('  begin');
    Script.Add('    suspend;');
    Script.Add('  end');
    Script.Add('end;');

    Script.Add('alter procedure saveblobtofile (');
    Script.Add('    chemin varchar(255),');
    Script.Add('    fichier varchar(255),');
    Script.Add('    blobcontent blob sub_type 0 segment size 80)');
    Script.Add('returns (');
    Script.Add('    result integer)');
    Script.Add('as');
    Script.Add('begin');
    Script.Add('  select udf_saveblobtofile(:chemin, :fichier, :blobcontent) from rdb$database into :result;');
    Script.Add('  suspend;');
    Script.Add('end;');

    Script.Add('alter procedure searchfilename (');
    Script.Add('    chemin varchar(255),');
    Script.Add('    old_filename varchar(255),');
    Script.Add('    reserve integer)');
    Script.Add('returns (');
    Script.Add('    new_filename varchar(255))');
    Script.Add('as');
    Script.Add('begin');
    Script.Add('  select udf_searchfilename(:chemin, :old_filename, :reserve) from rdb$database into :new_filename;');
    Script.Add('  suspend;');
    Script.Add('end;');

    Script.Add('alter procedure series_albums (');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    titreserie type of column series.titreserie,');
    Script.Add('    countserie integer,');
    Script.Add('    id_serie type of column series.id_serie)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(132);');
    Script.Add('begin');
    Script.Add('  swhere = '''';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = ''and '' || filtre;');
    Script.Add('');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      cast(''''-1'''' as varchar(150)), id_serie, count(id_album)');
    Script.Add('    from');
    Script.Add('      vw_liste_albums');
    Script.Add('    where');
    Script.Add('      titreserie is null '' || swhere || ''');
    Script.Add('    group by');
    Script.Add('      titreserie, id_serie''');
    Script.Add('    into');
    Script.Add('      :titreserie, :id_serie, :countserie');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      titreserie, id_serie, count(id_album)');
    Script.Add('    from');
    Script.Add('      vw_liste_albums');
    Script.Add('    where');
    Script.Add('      titreserie is not null '' || swhere || ''');
    Script.Add('    group by');
    Script.Add('      titreserie, id_serie''');
    Script.Add('    into');
    Script.Add('      :titreserie, :id_serie, :countserie');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('end;');

    Script.Add('alter procedure series_by_initiale (');
    Script.Add('    initiale t_initiale)');
    Script.Add('returns (');
    Script.Add('    id_serie type of column series.id_serie,');
    Script.Add('    titreserie type of column series.titreserie,');
    Script.Add('    id_editeur type of column editeurs.id_editeur,');
    Script.Add('    nomediteur type of column editeurs.nomediteur,');
    Script.Add('    id_collection type of column collections.id_collection,');
    Script.Add('    nomcollection type of column collections.nomcollection)');
    Script.Add('as');
    Script.Add('begin');
    Script.Add('  for');
    Script.Add('    select');
    Script.Add('      id_serie, s.titreserie,');
    Script.Add('      s.id_editeur, e.nomediteur, s.id_collection, c.nomcollection');
    Script.Add('      from');
    Script.Add('        series s');
    Script.Add('        left join editeurs e on');
    Script.Add('          s.id_editeur = e.id_editeur');
    Script.Add('        left join collections c on');
    Script.Add('          s.id_collection = c.id_collection');
    Script.Add('      where');
    Script.Add('        s.initialetitreserie = :initiale');
    Script.Add('      order by');
    Script.Add('        s.titreserie, e.nomediteur, c.nomcollection');
    Script.Add('      into');
    Script.Add('        :id_serie, :titreserie,');
    Script.Add('        :id_editeur, :nomediteur, :id_collection, :nomcollection');
    Script.Add('  do');
    Script.Add('  begin');
    Script.Add('    suspend;');
    Script.Add('  end');
    Script.Add('end;');

    Script.Add('alter procedure series_parabd (');
    Script.Add('    filtre varchar(125))');
    Script.Add('returns (');
    Script.Add('    titreserie type of column series.titreserie,');
    Script.Add('    countserie integer,');
    Script.Add('    id_serie type of column series.id_serie)');
    Script.Add('as');
    Script.Add('declare variable swhere varchar(132);');
    Script.Add('begin');
    Script.Add('  swhere = '''';');
    Script.Add('  if (filtre is not null and filtre <> '''') then');
    Script.Add('    swhere = ''and '' || filtre;');
    Script.Add('');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      cast(''''-1'''' as varchar(150)), id_serie, count(id_parabd)');
    Script.Add('    from');
    Script.Add('      vw_liste_parabd');
    Script.Add('    where');
    Script.Add('      titreserie is null '' || swhere || ''');
    Script.Add('    group by');
    Script.Add('      titreserie, id_serie''');
    Script.Add('    into');
    Script.Add('      :titreserie, :id_serie, :countserie');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('');
    Script.Add('  for execute statement');
    Script.Add('    ''select');
    Script.Add('      titreserie, id_serie, count(id_parabd)');
    Script.Add('    from');
    Script.Add('      vw_liste_parabd');
    Script.Add('    where');
    Script.Add('      titreserie is not null '' || swhere || ''');
    Script.Add('    group by');
    Script.Add('      titreserie, id_serie''');
    Script.Add('    into');
    Script.Add('      :titreserie, :id_serie, :countserie');
    Script.Add('  do');
    Script.Add('    suspend;');
    Script.Add('end;');

    ExecuteScript;
  end;
end;

initialization

RegisterFBUpdate('2.2.1.155', @MAJ2_2_1_155);

end.
